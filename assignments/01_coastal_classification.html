
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stacking 6 years of imagery into a GIF &#8212; CoastalCodeBook</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tidal constituents" href="02_tidal_constituents.html" />
    <link rel="prev" title="Introduction" href="../introduction/03_markdown.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CoastalCodeBook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to Coastal Systems Codebook
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About this book
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown.html">
   Markdown Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../markdown-notebooks.html">
   Notebooks with MyST Markdown
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../content.html">
   Content in Coastal Systems Codebook
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/01_basics.html">
   Chapter 1: Python Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/02_loops_and_functions.html">
   Chapter 2: Loops &amp; Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction/03_markdown.html">
   Introduction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Assignments
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Stacking 6 years of imagery into a GIF
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_tidal_constituents.html">
   Tidal constituents
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_tidal_inlets.html">
   Tidal inlets
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/floriscalkoen/CoastalCodeBook/main?urlpath=tree/docs/assignments/01_coastal_classification.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/floriscalkoen/CoastalCodeBook"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/floriscalkoen/CoastalCodeBook/issues/new?title=Issue%20on%20page%20%2Fassignments/01_coastal_classification.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/assignments/01_coastal_classification.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#search-for-stac-items">
   Search for STAC items
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-an-xarray-with-stacksatc">
   Create an xarray with stacksatc
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mask-cloudy-pixels-using-the-qa-band">
   Mask cloudy pixels using the QA band
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-biannual-median-composites">
   Make biannual median composites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#render-the-gif">
   Render the GIF
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Stacking 6 years of imagery into a GIF</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#search-for-stac-items">
   Search for STAC items
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-an-xarray-with-stacksatc">
   Create an xarray with stacksatc
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mask-cloudy-pixels-using-the-qa-band">
   Mask cloudy pixels using the QA band
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#make-biannual-median-composites">
   Make biannual median composites
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#render-the-gif">
   Render the GIF
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="stacking-6-years-of-imagery-into-a-gif">
<h1>Stacking 6 years of imagery into a GIF<a class="headerlink" href="#stacking-6-years-of-imagery-into-a-gif" title="Permalink to this headline">#</a></h1>
<p>We’ll load all the <a class="reference external" href="https://planetarycomputer.microsoft.com/dataset/landsat-8-c2-l2">Landsat-8 (Collection 2, Level 2)</a> data that’s available from <a class="reference external" href="https://planetarycomputer.microsoft.com/">Microsoft’s Planetary Computer</a> over a small region on the coast of <a class="reference external" href="https://www.google.com/maps/place/Chatham,+MA/&#64;41.7498076,-70.2026227,10.73z/data=%214m13%211m7%213m6%211s0x89fb15440149e94d:0x1f9c0efa001cb20b%212sCape+Cod%213b1%218m2%213d41.6687897%214d-70.2962408%213m4%211s0x89fb142168afbe53:0x714436ec7d485a53%218m2%213d41.6821432%214d-69.9597359">Cape Cod</a>, Massachusetts, USA.</p>
<p>Using nothing but standard xarray syntax, we’ll mask cloudy pixels with the Landsat QA band and reduce the data down to biannual median composites.</p>
<p><a class="reference external" href="https://geogif.readthedocs.io/en/latest/">Animated</a> as a GIF, we can watch the coastline move over the years due to <a class="reference external" href="https://en.wikipedia.org/wiki/Longshore_drift">longshore drift</a>.</p>
<p>Planetary Computer is Microsoft’s open Earth data initiative. It’s particularly nice to use, since they also maintain a <a class="reference external" href="https://planetarycomputer.microsoft.com/docs/quickstarts/reading-stac/">STAC API</a> for searching all the data, as well as a browseable <a class="reference external" href="https://planetarycomputer.microsoft.com/catalog">data catalog</a>. It’s free for anyone to use, though you have to <a class="reference external" href="https://planetarycomputer.microsoft.com/docs/concepts/sas/">sign your requests</a> with the <code class="docutils literal notranslate"><span class="pre">planetary_computer</span></code> package to prevent abuse. If you <a class="reference external" href="https://planetarycomputer.microsoft.com/account/request">sign up</a>, you’ll get faster reads.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">config</span> InlineBackend.figure_formats = [&#39;png2x&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import coiled</span>
<span class="kn">import</span> <span class="nn">distributed</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">import</span> <span class="nn">pystac_client</span>
<span class="kn">import</span> <span class="nn">planetary_computer</span> <span class="k">as</span> <span class="nn">pc</span>
<span class="kn">import</span> <span class="nn">ipyleaflet</span>
<span class="kn">import</span> <span class="nn">IPython.display</span> <span class="k">as</span> <span class="nn">dsp</span>
<span class="c1"># import geogif</span>
<span class="kn">import</span> <span class="nn">stackstac</span>
</pre></div>
</div>
</div>
</div>
<p>Using a cluster will make this <em>much</em> faster. Particularly if you’re not in Europe, which is where this data is stored.</p>
<p>You can sign up for a Coiled account and run clusters for free at <a class="reference external" href="https://cloud.coiled.io/">https://cloud.coiled.io/</a> — no credit card or username required, just sign in with your GitHub or Google account, then connect to your cloud provider account (AWS or GCP).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cluster = coiled.Cluster(</span>
<span class="c1">#     name=&quot;stackstac-eu&quot;,</span>
<span class="c1">#     n_workers=20,</span>
<span class="c1">#     package_sync=True,</span>
<span class="c1">#     backend_options={&quot;region&quot;: &quot;eu-central-1&quot;},</span>
<span class="c1">#     # ^ Coiled doesn&#39;t yet support Azure&#39;s West Europe region, so instead we&#39;ll run on a nearby AWS data center in Frankfurt</span>
<span class="c1"># )</span>
<span class="c1"># client = distributed.Client(cluster)</span>
<span class="c1"># client</span>
</pre></div>
</div>
</div>
</div>
<p>Interactively pick the area of interest from a map. Just move the map around and re-run all cells to generate the timeseries somewhere else!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">ipyleaflet</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">scroll_wheel_zoom</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="mf">41.64933994767867</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.94438630063088</span>
<span class="n">m</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">m</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="s2">&quot;800px&quot;</span>
<span class="n">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "42f5d5e83970428fa0f8c05722c63849"}
</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">west</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">south</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">east</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">north</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="search-for-stac-items">
<h2>Search for STAC items<a class="headerlink" href="#search-for-stac-items" title="Permalink to this headline">#</a></h2>
<p>Use <a class="reference external" href="https://github.com/stac-utils/pystac-client">pystac-client</a> to connect to Microsoft’s STAC API endpoint and search for Landsat-8 scenes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span> <span class="o">=</span> <span class="n">pystac_client</span><span class="o">.</span><span class="n">Client</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;https://planetarycomputer.microsoft.com/api/stac/v1&#39;</span><span class="p">)</span>

<span class="n">search</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
    <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;landsat-8-c2-l2&#39;</span><span class="p">],</span>
    <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Load and sign all the STAC items with a token from Planetary Computer. Without this, loading the data will fail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">search</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 6.92 ms, sys: 2.35 ms, total: 9.27 ms
Wall time: 388 ms
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<p>These are the footprints of all the items we’ll use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsp</span><span class="o">.</span><span class="n">GeoJSON</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;IPython.display.GeoJSON object&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-an-xarray-with-stacksatc">
<h2>Create an xarray with stacksatc<a class="headerlink" href="#create-an-xarray-with-stacksatc" title="Permalink to this headline">#</a></h2>
<p>Set <code class="docutils literal notranslate"><span class="pre">bounds_latlon=bbox</span></code> to automatically clip to our area of interest (instead of using the full footprints of the scenes).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%time</span>
<span class="c1"># stack = stackstac.stack(items, bounds_latlon=bbox)</span>
<span class="c1"># stack</span>
</pre></div>
</div>
</div>
</div>
<p>And that’s it for stackstac! Everything from here on is just standard xarray operations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # use common_name for bands</span>
<span class="c1"># stack = stack.assign_coords(band=stack.common_name.fillna(stack.band).rename(&quot;band&quot;))</span>
<span class="c1"># stack.band</span>
</pre></div>
</div>
</div>
</div>
<p>See how much input data there is for just RGB. This is the amount of data we’ll end up processing</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># stack.sel(band=[&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="mask-cloudy-pixels-using-the-qa-band">
<h2>Mask cloudy pixels using the QA band<a class="headerlink" href="#mask-cloudy-pixels-using-the-qa-band" title="Permalink to this headline">#</a></h2>
<p>Use the bit values of the Landsat-8 QA band to mask out bad pixels. We’ll mask pixels labeled as dilated cloud, cirrus, cloud, or cloud shadow. (By “mask”, we mean just replacing those pixels with NaNs).</p>
<p>See page 14 on <a class="reference external" href="https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/media/files/LSDS-1619_Landsat-8-9-C2-L2-ScienceProductGuide-v4.pdf">this PDF</a> for the data table describing which bit means what.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Make a bitmask---when we bitwise-and it with the data, it leaves just the 4 bits we care about</span>
<span class="c1"># mask_bitfields = [1, 2, 3, 4]  # dilated cloud, cirrus, cloud, cloud shadow</span>
<span class="c1"># bitmask = 0</span>
<span class="c1"># for field in mask_bitfields:</span>
<span class="c1">#     bitmask |= 1 &lt;&lt; field</span>

<span class="c1"># bin(bitmask)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># qa = stack.sel(band=&quot;QA_PIXEL&quot;).astype(&quot;uint16&quot;)</span>
<span class="c1"># bad = qa &amp; bitmask  # just look at those 4 bits</span>
<span class="c1"># good = stack.where(bad == 0)  # mask pixels where any one of those bits are set</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # What&#39;s the typical interval between scenes?</span>
<span class="c1"># good.time.diff(&quot;time&quot;).dt.days.plot.hist();</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="make-biannual-median-composites">
<h2>Make biannual median composites<a class="headerlink" href="#make-biannual-median-composites" title="Permalink to this headline">#</a></h2>
<p>The Landsat-8 scenes appear to typically be 5-15 days apart. Let’s composite that down to a 6-month interval.</p>
<p>Since the cloudy pixels we masked with NaNs will be ignored in the <code class="docutils literal notranslate"><span class="pre">median</span></code>, this should give us a decent cloud-free-ish image for each.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Make biannual median composites (`2Q` means 2 quarters)</span>
<span class="c1"># composites = good.resample(time=&quot;2Q&quot;).median(&quot;time&quot;)</span>
<span class="c1"># composites</span>
</pre></div>
</div>
</div>
</div>
<p>Pick the red-green-blue bands to make a true-color image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rgb = composites.sel(band=[&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;])</span>
<span class="c1"># rgb</span>
</pre></div>
</div>
</div>
</div>
<p>Some final cleanup to make a nicer-looking animation:</p>
<ul class="simple">
<li><p>Forward-fill any NaN pixels from the previous frame, to make the animation look less jumpy.</p></li>
<li><p>Also skip the first frame, since its NaNs can’t be filled from anywhere.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cleaned = rgb.ffill(&quot;time&quot;)[1:]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="render-the-gif">
<h2>Render the GIF<a class="headerlink" href="#render-the-gif" title="Permalink to this headline">#</a></h2>
<p>Use <a class="reference external" href="https://geogif.readthedocs.io/en/latest/">GeoGIF</a> to turn the stack into an animation. We’ll use <a class="reference external" href="https://geogif.readthedocs.io/en/latest/api.html#dask-dgif">dgif</a> to render the GIF on the cluster, so there’s less data to send back. (GIFs are a lot smaller than NumPy arrays!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># client.wait_for_workers(20)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %%time</span>
<span class="c1"># gif_img = geogif.dgif(cleaned).compute()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we turned ~7GiB of data into a 4MB GIF!</span>
<span class="c1"># dask.utils.format_bytes(len(gif_img.data))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># gif_img</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


<script type="application/vnd.jupyter.widget-state+json">
{"state": {"de3dcfd804d643a0b813c45fcf451e9d": {"model_name": "LeafletMapStyleModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletMapStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "cursor": "grab"}}, "ef4da64779ce4c6190397faf2d0c1a3d": {"model_name": "LeafletMapStyleModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletMapStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "cursor": "move"}}, "c6432504285e4f4c9c4b036ef125a9ba": {"model_name": "LeafletTileLayerModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletTileLayerModel", "_view_count": null, "_view_module": "jupyter-leaflet", "_view_module_version": "^0.17", "_view_name": "LeafletTileLayerView", "attribution": "&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors", "base": true, "bottom": true, "bounds": null, "detect_retina": false, "loading": false, "max_native_zoom": null, "max_zoom": 19, "min_native_zoom": null, "min_zoom": 1, "name": "OpenStreetMap.Mapnik", "no_wrap": false, "opacity": 1.0, "options": ["attribution", "bounds", "detect_retina", "max_native_zoom", "max_zoom", "min_native_zoom", "min_zoom", "no_wrap", "tile_size", "tms", "zoom_offset"], "pane": "", "popup": null, "popup_max_height": null, "popup_max_width": 300, "popup_min_width": 50, "show_loading": false, "subitems": [], "tile_size": 256, "tms": false, "url": "https://tile.openstreetmap.org/{z}/{x}/{y}.png", "visible": true, "zoom_offset": 0}}, "489d8ae7b1c84398a6c48587de02603c": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "800px", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e41398cffbd54497be808e2e56ecdd66": {"model_name": "LeafletMapStyleModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletMapStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "cursor": "grab"}}, "42f5d5e83970428fa0f8c05722c63849": {"model_name": "LeafletMapModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_dom_classes": [], "_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletMapModel", "_view_count": null, "_view_module": "jupyter-leaflet", "_view_module_version": "^0.17", "_view_name": "LeafletMapView", "bottom": 0.0, "bounce_at_zoom_limits": true, "box_zoom": true, "center": [41.64933994767867, -69.94438630063088], "close_popup_on_click": true, "controls": ["IPY_MODEL_e930c768f46345df877db7e8add7fb03", "IPY_MODEL_ebb7e2109c704a42b1d17f4b928480aa"], "crs": {"name": "EPSG3857", "custom": false}, "default_style": "IPY_MODEL_de3dcfd804d643a0b813c45fcf451e9d", "double_click_zoom": true, "dragging": true, "dragging_style": "IPY_MODEL_ef4da64779ce4c6190397faf2d0c1a3d", "east": 0.0, "fullscreen": false, "inertia": true, "inertia_deceleration": 3000, "inertia_max_speed": 1500, "interpolation": "bilinear", "keyboard": true, "keyboard_pan_offset": 80, "keyboard_zoom_offset": 1, "layers": ["IPY_MODEL_c6432504285e4f4c9c4b036ef125a9ba"], "layout": "IPY_MODEL_489d8ae7b1c84398a6c48587de02603c", "left": 9007199254740991.0, "max_zoom": null, "min_zoom": null, "modisdate": "2023-01-16", "north": 0.0, "options": ["bounce_at_zoom_limits", "box_zoom", "center", "close_popup_on_click", "double_click_zoom", "dragging", "fullscreen", "inertia", "inertia_deceleration", "inertia_max_speed", "interpolation", "keyboard", "keyboard_pan_offset", "keyboard_zoom_offset", "max_zoom", "min_zoom", "prefer_canvas", "scroll_wheel_zoom", "tap", "tap_tolerance", "touch_zoom", "world_copy_jump", "zoom", "zoom_animation_threshold", "zoom_delta", "zoom_snap"], "panes": {}, "prefer_canvas": false, "right": 0.0, "scroll_wheel_zoom": true, "south": 0.0, "style": "IPY_MODEL_e41398cffbd54497be808e2e56ecdd66", "tap": true, "tap_tolerance": 15, "top": 9007199254740991.0, "touch_zoom": true, "west": 0.0, "window_url": "", "world_copy_jump": false, "zoom": 12.0, "zoom_animation_threshold": 4, "zoom_delta": 1.0, "zoom_snap": 1.0}}, "e930c768f46345df877db7e8add7fb03": {"model_name": "LeafletZoomControlModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletZoomControlModel", "_view_count": null, "_view_module": "jupyter-leaflet", "_view_module_version": "^0.17", "_view_name": "LeafletZoomControlView", "options": ["position", "zoom_in_text", "zoom_in_title", "zoom_out_text", "zoom_out_title"], "position": "topleft", "zoom_in_text": "+", "zoom_in_title": "Zoom in", "zoom_out_text": "-", "zoom_out_title": "Zoom out"}}, "ebb7e2109c704a42b1d17f4b928480aa": {"model_name": "LeafletAttributionControlModel", "model_module": "jupyter-leaflet", "model_module_version": "^0.17", "state": {"_model_module": "jupyter-leaflet", "_model_module_version": "^0.17", "_model_name": "LeafletAttributionControlModel", "_view_count": null, "_view_module": "jupyter-leaflet", "_view_module_version": "^0.17", "_view_name": "LeafletAttributionControlView", "options": ["position", "prefix"], "position": "bottomright", "prefix": "ipyleaflet"}}}, "version_major": 2, "version_minor": 0}
</script>


    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./assignments"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../introduction/03_markdown.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Introduction</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="02_tidal_constituents.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tidal constituents</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Floris Calkoen<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>